{% extends 'base.html' %} {% load static %}
{% load humanize %}
{% block content %}

{% if user.is_authenticated %}
<div class="container mx-auto px-2">
    <div class="max-w-6xl mx-auto flex flex-wrap items-start py-6 px-6 xl:px-0">
        <div class="products w-full lg:w-3/4 text-body">
            <h1 class="mb-5 text-3xl">Checkout</h1>
            <div class="w-full pr-6">
                <div class="mb-6 p-6 bg-gray-100 rounded-xl">
                    <h4 class="mb-5 uppercase text-lg">Collection information</h4>
                    <div class="flex space-x-6">
                        <div class="w-1/2 mb-4">
                            <label class="inline-block mb-2">First name </label><br />
                            <input name="first_name" type="text" class="w-full p-5 rounded-xl" value="{{ request.user.first_name }}">
                        </div>
                        <div class="w-1/2 mb-4">
                            <label class="inline-block mb-2">Last name</label><br />
                            <input name="last_name" type="text" class="w-full p-5 rounded-xl" value="{{ request.user.last_name }}">
                        </div>
                        <div class="mb-4">
                            <label class="inline-block mb-2">Email</label><br />
                            <input name="email" type="email" class="w-full p-5 rounded-xl" value="{{ request.user.email }}"> 
                        </div>
                        <div class="flex space-x-6">
                            <div class="w-1/2 mb-4">
                                <label class="inline-block mb-2"> Contact No </label><br />
                                <input name="phone" type="text" class="w-full p-5 rounded-xl" value="{{ request.user.phone }}"> 
                            </div>  
                            <div class="w-1/2 mb-4">
                                <label class="inline-block mb-2">Other</label><br />
                                <input type="text" class="w-full p-5 rounded-xl">
                            </div>
                        </div>
                    </div>
                    <div class="mb-6 p-6 bg-gray-100 rounded-xl">
                        <h4 class="mb-5 uppercase text-lg">Contact information</h4>
                        <div class="mb-4">
                            <label class="inline-block mb-2">Email</label><br />
                            <input type="email" class="w-full p-5 rounded-xl" value="{{ request.user.email }}">
                        </div>
                        <div class="mb-6 p-6 bg-gray-100 rounded-xl">
                            <h4 class="mb-2 uppercase text-lg">Payment information</h4>
                            <input type="text" class="w-full p-5 rounded-xl">
                        </div>
                    </div>
                    <div class="summary w-full w-1/4 p-6 bg-gray-100 rounded-xl mt-3">
                        <h4 class="uppercase text-lg mb-2">Summary</h4>
                        <div class="mb-6 flex justify-between">
                            <span class="font-semibold">Total</span>
                            <span>HK$ {{ cart.get_total_cost }}</span>
                        </div>
                    <button 
                    onclick="buy(event)"
                    href="{% url 'cart:checkout' %}" class="inline-block px-8 py-4 bg-warning text-body"
                    >
                        Confirm Checkout
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://js.stripe.com/v3"></script>
<script>
    function validateForm(data) {
        let errors = [];
        if (!data.first_name) errors.push('First name is empty');
        if (!data.last_name) errors.push('Last name is empty');
        if (!data.email) errors.push('Email is empty');
        if (!data.phone) errors.push('Phone is empty');
        return errors;
    }

    function buy(event) {
        event.preventDefault();

        const first_name = document.querySelector('input[name="first_name"]');
        const last_name = document.querySelector('input[name="last_name"]');
        const email = document.querySelector('input[name="email"]');
        const phone = document.querySelector('input[name="phone"]');

        if (!first_name || !last_name || !email || !phone) {
            console.error('Missing required input fields');
            return;
        }

        const data = {
            first_name: first_name.value,
            last_name: last_name.value,
            email: email.value,
            phone: phone.value,
        };

        const errors = validateForm(data);
        if (errors.length) {
            alert('Please fix the following:\n' + errors.join('\n'));
            return;
        }

        const stripe = Stripe('{{ pub_key }}');  // ← 這裡依賴 view 傳入 pub_key

        fetch('/orders/start_order', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(session => {
            return stripe.redirectToCheckout({ sessionId: session.session.id });
        })
        .then(result => {
            if (result.error) {
                alert(result.error.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred during checkout. Please try again.');
        });
    }

    document.addEventListener('DOMContentLoaded', function () {
        const button = document.getElementById('confirm-checkout-btn');
        if (button) {
            button.addEventListener('click', buy);
        } else {
            console.error('Confirm Checkout button not found!');
        }
    });
</script>
</div>
{% else %}
<div class="max-w-6xl mx-auto flex flex-wrap items-start py-6 px-6 xl:px-0">
    <div class="products w-full lg:w-3/4 text-center text-body">
        <p class="mb-3">Please log in to proceed to checkout.</p>
        <a href="{% url 'accounts:login_cart' %}" class="inline-block px-8 py-4 rounded-xl bg-purple-500 hover:bg-purple-700 text-primary">Continue login</a>
    </div>
</div>
<br /><br />
{% endif %}

{% endblock %}